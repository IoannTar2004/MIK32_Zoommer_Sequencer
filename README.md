## Практический пример Лекции 9
Данный репозиторий демонстрирует работу приема данных по UART с помощью механизма прерываний, перенос данных из одного массива данных в другой, а также передачу по UART с помощью DMA.

Логика примера построена на том, что по UART с компьютера на скорости 115200 должны быть получены байты в количестве, определяемом параметром BYTES_EXPECTED_TO_RECIEVE, в примере 16.
В обработчике прерываний по событии RXNE каждый байт по приёму укладывается в кольцевой буфер.

В основном потоке программа регулярно вызывает move_incoming_data_to_src_mem(), где перекладывает данные из кольцевого буфера в src_mem и по достижении предела в BYTES_EXPECTED_TO_RECIEVE выставляет флаг готовности data_processed.
Как только данные готовы, они с помощью DMA на CHANNEL_1 переносятся между участками памяти в функции move_data_from_src_to_dst_mem.
Затем демонстрируется работа crc8 модуля, который принимает на вход скопированный на массив, рассчитывает по его содержимому контрольную сумму и цепляет её последним байтом.
Модуль crc8 умеет расчитывать контрольную сумму по частичному содержимому.

После этого, запускается передача по UART на компьютер при помощи DMA и в терминале можно видеть отправленную посылку вместе с контрольной суммой.

В репо также имеется не задействованная в примере стурктура данных типа Очередь (queue.h/.c). Ее функционал в вашем распоряжении.

## Домашнее задание

С компьютера на микроконтроллер приходит поток данных, закодированный по протоколу, описание которого вы найдете в презентации на слайде 30. Нужно написать свой парсер протокола, извлечь из потока все пакеты, выполнить проверку контрольной суммы строго для байт с 4-го по 7-й (полезные данные) и отправить обратно на компьютер только валидные полезные данные. 

Например, контроллер получает пакет 0xC0FFEE05AC42FE9847 (заголовок длина данные контрольная сумма) и отправляет на компьютер 0xAC42FE98.

Необходимо подстроить параметр BYTES_EXPECTED_TO_RECIEVE.

Для приема передачи рекомендуется использовать [терминал Брая](https://sites.google.com/site/terminalbpp/) на строноне Windows вне контейнера. В него нужно будет загрузить макрос bray_macros.tfm (прилагается в репо) и на панели макросов для посылки потока данных использовать кнопки М1-М3. Таким образом будет отправляться поток данных на контроллер, с которыми вам нужно выполнить работу.

Если нет возможности запустить терминал Брая, то нужно запустить скрипт stream_data.sh, который отправит все данные по uart. В скрипте следите за портом "> /dev/ttyUSB0" в который идет вывод.
Перез запуском скрипта, запустите еще одно окно терминала и в нём выполните команду make monitor, что позволит следить за происходящим.

Makefile для monitor цели изменен так, чтобы можно было видеть символы в HEX формате.


## Документация на MIK32 АМУР
 * [HTML - mik32-amur.ru](https://mik32-amur.ru/)
 * [PDF - nc.mikron.ru](https://nc.mikron.ru/s/keWGji8jfmsPeDo/download)


## Установка
1. Скачать и установить [VS Code](https://code.visualstudio.com/)
2. Следуя инструкции [DevContainers Installation](https://code.visualstudio.com/docs/devcontainers/containers#_installation), установить Docker и DevContainer плагин для VS Code

> :warning: Если у вас Windows, вам так же необходимо выполнить пункт [Настройка отладчика](#настройка-отладчика)

## Настройка отладчика (Windows)
> :bulb: Пользователям Linux эти шаги **выполнять не нужно**
1. Открыть терминал от имени администратора
2. Ввести команду `winget install usbipd`
3. Выполнить все инструкции на экране
4. Подключить отладчик по USB
5. Ввести команду `usbipd list`
6. Найти в списке устройство с именем "Dual RS232-HS" (или с VID:PID "0403:6010") и скопировать его "BUSID" <br>
7. Ввести команду `usbipd bind --busid=<BUSID> --force`
8. Ввести команду `usbipd attach --auto-attach --wsl --busid <BUSID>` <br>
(:warning: данную команду необходимо выполнять каждый раз после переподключения отладчика) <br>
(:warning: если отладчик все еще не доступен внутри контейнера, то нужно перезапустить vs code)

## Запуск
> :warning: Если у вас Windows, то необходимо выполнить пункт 8 из [настройки отладчика](#настройка-отладчика)
1. Открыть папку с репозиторием в VS Code
2. Нажать сочетание клавиш "Ctrl + Shift + P"
3. Ввести "Dev Containers: Open Folder in Container"
4. Нажать Enter
5. Дождаться сборки контейнера и настройки VS Code

> :warning: Выше описанные шаги необходимо выполнить только первый раз.
В следующий раз достаточно в VS Code открыть проект `mik32_base_project @ desktop-linux [Dev Container]`

## Сборка
В терминале Dev Containers ввести команду `make`
*(для удаления артефактов сборки ввести `make clean`)*

## Загрузка прошивки
> :bulb: Для того чтобы избежать проблем при загрузке прошики, всегда **подключайте отладчик** и выполняйте пункт 8 из [настройки отладчика](#настройка-отладчика) (если у вас Windows) **до запуска VS Code**.

В терминале Dev Containers ввести команду `make flash`

## Serial monitor

1. Подключить плату через USB type-c провод.
2. Выполнить проброс в wsl устройства `USB-SERIAL CH340` аналогично [Настройка отладчика (Windows)](#Настройка-отладчика-(Windows))
3. В (опционально в новом) терминале Dev Containers ввести команду `make monitor`
4. Выход из терминала возможен по последовательному нажатию сочетаний `ctrl`+`a`,затем `ctrl`+`x`.

## Отладка

* Используется функциональность VS code и плагина [cortex-debug](https://github.com/Marus/cortex-debug).
* Перед запуском отладчика нужно выполнить сборку проекта и прошивку МК командой `make build_app flash`.
* gdb-команда `load` не поддерживается, загрузка в память возможна только с помощью скрипта `mik32_upload.py`. Либо командой `make flash`
* Иногда установка плагина [cortex-debug](https://github.com/Marus/cortex-debug) выполняется с ошибкой, тогда нужно переустановить его внутри контейнера вручную через UI VS code.